<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File Manager</title>
<link rel="icon" type="image/png" href="img/icon.png" />
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --bg-hover: #30363d;
    --border-color: #30363d;
    --text-primary: #e6edf3;
    --text-secondary: #7d8590;
    --accent: #2f81f7;
    --accent-hover: #1f6feb;
    --success: #3fb950;
    --danger: #f85149;
    --folder-color: #54a3ff;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    height: 100vh;
    overflow: hidden;
}

/* HEADER */
header {
    text-align: center;
    padding: 20px;
    font-size: 24px;
    font-weight: 600;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
}

/* BREADCRUMB */
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
    overflow-x: auto;
    white-space: nowrap;
}

.breadcrumb-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    color: var(--accent);
    transition: color 0.2s;
}

.breadcrumb-item:hover {
    color: var(--accent-hover);
    text-decoration: underline;
}

.breadcrumb-separator {
    color: var(--text-secondary);
}

.depth-indicator {
    color: var(--text-secondary);
    font-size: 12px;
    margin-left: 8px;
}

/* MAIN WRAPPER */
#wrap {
    display: flex;
    height: calc(100vh - 120px);
}

/* SIDEBAR */
#files {
    width: 280px;
    border-right: 1px solid var(--border-color);
    background: var(--bg-secondary);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#files button {
    width: calc(100% - 24px);
    margin: 12px 12px 0;
    padding: 10px 16px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
}

#files button:hover {
    background: var(--bg-hover);
    border-color: var(--accent);
}

.btn-primary {
    background: var(--accent) !important;
    border-color: var(--accent) !important;
    color: white !important;
}

.btn-primary:hover {
    background: var(--accent-hover) !important;
    border-color: var(--accent-hover) !important;
}

.btn-success {
    background: var(--success) !important;
    border-color: var(--success) !important;
    color: white !important;
}

.btn-danger {
    background: var(--danger) !important;
    border-color: var(--danger) !important;
    color: white !important;
}

/* FILE LIST */
#fileList {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

#fileList::-webkit-scrollbar {
    width: 10px;
}

#fileList::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

#fileList::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 5px;
}

#fileList::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

.file-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    margin-bottom: 4px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    position: relative;
}

.file-item:hover {
    background: var(--bg-hover);
}

.file-item.active {
    background: var(--bg-tertiary);
    border: 1px solid var(--accent);
}

.file-icon {
    width: 18px;
    height: 18px;
    margin-right: 10px;
    flex-shrink: 0;
}

.folder-icon {
    fill: var(--folder-color);
}

.file-icon-default {
    fill: var(--text-secondary);
}

.file-name {
    flex: 1;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-actions {
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.2s;
}

.file-item:hover .file-actions {
    opacity: 1;
}

.icon-btn {
    padding: 4px 8px;
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 4px;
    font-size: 11px;
    transition: all 0.2s;
}

.icon-btn:hover {
    background: var(--bg-primary);
    color: var(--text-primary);
    border-color: var(--border-color);
}

.icon-btn.delete:hover {
    color: var(--danger);
    border-color: var(--danger);
}

/* EDITOR AREA */
#editorArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

#editor {
    flex: 1;
    padding: 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    outline: none;
    resize: none;
    overflow-y: auto;
}

#editor::-webkit-scrollbar {
    width: 10px;
}

#editor::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

#editor::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 5px;
}

/* MESSAGES */
#error, #success {
    display: none;
    padding: 12px 20px;
    margin: 12px 20px 0;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
}

#error {
    background: rgba(248, 81, 73, 0.15);
    border: 1px solid var(--danger);
    color: #ff7b72;
}

#success {
    background: rgba(63, 185, 80, 0.15);
    border: 1px solid var(--success);
    color: #7ee787;
}

/* MODALS */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 24px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h2 {
    font-size: 18px;
    font-weight: 600;
}

.modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 24px;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal input[type="text"] {
    width: 100%;
    padding: 10px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 14px;
    margin-bottom: 12px;
}

.modal input[type="text"]:focus {
    outline: none;
    border-color: var(--accent);
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 16px;
}

.modal button {
    padding: 8px 16px;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.modal button:hover {
    background: var(--bg-hover);
}

/* UPLOAD AREA */
.upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 6px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-primary);
    margin: 12px 0;
}

.upload-area:hover {
    border-color: var(--accent);
    background: var(--bg-tertiary);
}

#uploadPreview {
    max-width: 100%;
    margin-top: 12px;
    display: none;
    border-radius: 6px;
}

input[type="file"] {
    display: none;
}

/* OPTIONS MENU */
#optionsMenu {
    display: none;
    margin: 0 12px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
}

#optionsMenu div {
    padding: 10px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

#optionsMenu div:hover {
    background: var(--bg-hover);
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.empty-state svg {
    width: 48px;
    height: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
}

@media (max-width: 768px) {
    #wrap {
        flex-direction: column;
    }

    #files {
        width: 100%;
        height: 300px;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
    }

    .file-actions {
        opacity: 1;
    }

    #editorArea {
        padding: 12px;
    }
}
</style>
</head>
<body>

<header>File Manager</header>

<div class="breadcrumb" id="breadcrumb"></div>

<div id="error"></div>
<div id="success"></div>

<!-- CREATE FILE MODAL -->
<div class="modal" id="createModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="createTitle">Create New File</h2>
            <button class="modal-close" onclick="closeModal('createModal')">×</button>
        </div>
        <input type="text" id="createFilename" placeholder="example: index.html or img/logo.png">
        <p style="font-size: 12px; color: var(--text-secondary); margin-top: -8px;">
            Use "/" to create folders (e.g., "css/style.css" creates folder "css")
        </p>
        <div class="modal-actions">
            <button onclick="closeModal('createModal')">Cancel</button>
            <button class="btn-success" onclick="confirmCreate()">Create</button>
        </div>
    </div>
</div>

<!-- CREATE FOLDER MODAL -->
<div class="modal" id="folderModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Folder</h2>
            <button class="modal-close" onclick="closeModal('folderModal')">×</button>
        </div>
        <input type="text" id="folderName" placeholder="folder-name">
        <div class="modal-actions">
            <button onclick="closeModal('folderModal')">Cancel</button>
            <button class="btn-success" onclick="confirmCreateFolder()">Create Folder</button>
        </div>
    </div>
</div>

<!-- UPLOAD IMAGE MODAL -->
<div class="modal" id="uploadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Upload Image</h2>
            <button class="modal-close" onclick="closeModal('uploadModal')">×</button>
        </div>
        <input type="text" id="uploadFilename" placeholder="example: photo.png or img/photo.png">
        <p style="font-size: 12px; color: var(--text-secondary); margin-top: -8px;">
            Use "/" to upload to folder (e.g., "img/photo.png")
        </p>
        <div class="upload-area" id="uploadDrop">
            <svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z"></path>
            </svg>
            <p>Click or drop image here</p>
        </div>
        <input type="file" id="uploadInput" accept="image/*">
        <img id="uploadPreview">
        <div class="modal-actions">
            <button onclick="closeModal('uploadModal')">Cancel</button>
            <button class="btn-success" onclick="uploadAndDeployImageBinary()">Upload</button>
        </div>
    </div>
</div>

<div id="wrap">
    <div id="files">
        <button class="btn-primary" onclick="createFolder()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1.75 2A1.75 1.75 0 0 0 0 3.75v8.5C0 13.216.784 14 1.75 14h12.5A1.75 1.75 0 0 0 16 12.25v-6.5A1.75 1.75 0 0 0 14.25 4H7.5L5.66 2.16A1.75 1.75 0 0 0 4.42 2H1.75Z"></path>
            </svg>
            New Folder
        </button>
        <button class="btn-primary" onclick="createFile()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M11 1H3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V5l-4-4ZM9.5 3.5v3a.5.5 0 0 0 .5.5h3L9.5 3.5Z"></path>
            </svg>
            New File
        </button>
        <button onclick="openUpload()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                <path d="M11.78 4.72a.749.749 0 1 1-1.06 1.06L8.75 3.811V9.5a.75.75 0 0 1-1.5 0V3.811L5.28 5.78a.749.749 0 1 1-1.06-1.06l3.25-3.25a.749.749 0 0 1 1.06 0l3.25 3.25Z"></path>
            </svg>
            Upload Image
        </button>
        <button class="btn-success" onclick="saveFile()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"></path>
            </svg>
            SAVE FILE
        </button>
        <button onclick="deploy()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1 2.5A2.5 2.5 0 0 1 3.5 0h8.75a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0V1.5h-8a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h8V10.5a.75.75 0 0 1 1.5 0v3.75a.75.75 0 0 1-.75.75H3.5A2.5 2.5 0 0 1 1 12.5v-10Z"></path>
            </svg>
            DEPLOY
        </button>
        <button onclick="album()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1.75 2.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-10.5a.25.25 0 0 0-.25-.25H1.75ZM0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25V2.75Zm3 2a1 1 0 1 1 2 0 1 1 0 0 1-2 0Zm9.5 5.5-3.5-3.5-5.5 5.5h9Z"></path>
            </svg>
            Album
        </button>
        <button onclick="toggleOptions()">
            OPTIONS ▾
        </button>
        <div id="optionsMenu">
            <div onclick="downloadCurrentFile()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14Z"></path>
                    <path d="M7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"></path>
                </svg>
                Download File
            </div>
            <div onclick="deleteCurrentFile()" style="color: var(--danger);">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15Z"></path>
                </svg>
                Delete File
            </div>
        </div>
        <div id="fileList"></div>
    </div>

    <div id="editorArea">
        <textarea id="editor" placeholder="Select a file or create a new one..."></textarea>
    </div>
</div>

<script>
const API = "https://code-mon.codemon.workers.dev";
const MAX_FOLDER_DEPTH = 5;

let user = null;
let pass = null;
let currentFile = null;
let currentPath = [];
let uploadFileData = null;
let allFiles = [];

// Auth check
(async function() {
    user = localStorage.getItem("code-mon-username");
    pass = localStorage.getItem("code-mon-pass");

    if (!user || !pass) {
        localStorage.clear();
        location.href = "login.html";
        return;
    }

    try {
        const res = await fetch(`${API}/api/pass?username=${user}&pass=${pass}`);
        const data = await res.json();

        if (!data.success) {
            localStorage.clear();
            location.href = "login.html";
            return;
        }

        console.log("User authenticated:", user);
        loadFiles();

    } catch (err) {
        localStorage.clear();
        location.href = "login.html";
    }
})();

// Utility functions
function showError(msg) {
    const e = document.getElementById("error");
    e.style.display = "block";
    e.innerText = msg;
    setTimeout(() => e.style.display = "none", 4000);
}

function showSuccess(msg) {
    const s = document.getElementById("success");
    s.style.display = "block";
    s.innerText = msg;
    setTimeout(() => s.style.display = "none", 3000);
}

function clearError() {
    document.getElementById("error").style.display = "none";
}

function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// Parse files into folder structure
function parseFilesIntoFolders(fileList) {
    const structure = {};
    
    fileList.forEach(filepath => {
        // Skip image files from display (they're in album)
        if (/\.(png|jpg|jpeg|gif|webp|svg)$/i.test(filepath)) return;
        
        const parts = filepath.split('/');
        let current = structure;
        
        // Build folder structure
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) {
                current[parts[i]] = { _isFolder: true, _children: {} };
            }
            current = current[parts[i]]._children;
        }
        
        // Add file
        const fileName = parts[parts.length - 1];
        current[fileName] = { _isFile: true, _fullPath: filepath };
    });
    
    return structure;
}

// Get current directory
function getCurrentDir(structure) {
    let dir = structure;
    for (let folder of currentPath) {
        if (dir[folder] && dir[folder]._isFolder) {
            dir = dir[folder]._children;
        }
    }
    return dir;
}

// Update breadcrumb
function updateBreadcrumb() {
    const breadcrumb = document.getElementById('breadcrumb');
    
    if (currentPath.length === 0) {
        breadcrumb.innerHTML = '<div class="breadcrumb-item">Root</div>';
    } else {
        let html = '<div class="breadcrumb-item" onclick="navigateToRoot()">Root</div>';
        currentPath.forEach((folder, index) => {
            html += '<span class="breadcrumb-separator">/</span>';
            html += `<div class="breadcrumb-item" onclick="navigateToPath(${index})">${folder}</div>`;
        });
        html += `<span class="depth-indicator">(Depth: ${currentPath.length}/${MAX_FOLDER_DEPTH})</span>`;
        breadcrumb.innerHTML = html;
    }
}

// Navigate to root
function navigateToRoot() {
    currentPath = [];
    renderFileList();
    updateBreadcrumb();
}

// Navigate to specific path
function navigateToPath(index) {
    currentPath = currentPath.slice(0, index + 1);
    renderFileList();
    updateBreadcrumb();
}

// Render file list
function renderFileList() {
    const fileList = document.getElementById('fileList');
    const structure = parseFilesIntoFolders(allFiles);
    const dir = getCurrentDir(structure);
    const entries = Object.entries(dir);

    if (entries.length === 0) {
        fileList.innerHTML = `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                </svg>
                <p>No files or folders</p>
            </div>
        `;
        return;
    }

    // Sort: folders first, then files
    const folders = entries.filter(([_, value]) => value._isFolder);
    const files = entries.filter(([_, value]) => value._isFile);

    let html = '';

    // Render folders
    folders.forEach(([name, _]) => {
        html += `
            <div class="file-item" onclick="openFolder('${name}')">
                <svg class="file-icon folder-icon" viewBox="0 0 16 16">
                    <path d="M1.75 2A1.75 1.75 0 0 0 0 3.75v8.5C0 13.216.784 14 1.75 14h12.5A1.75 1.75 0 0 0 16 12.25v-6.5A1.75 1.75 0 0 0 14.25 4H7.5L5.66 2.16A1.75 1.75 0 0 0 4.42 2H1.75Z"></path>
                </svg>
                <span class="file-name">${name}</span>
                <div class="file-actions">
                    <button class="icon-btn delete" onclick="event.stopPropagation(); deleteFolder('${name}')">Delete</button>
                </div>
            </div>
        `;
    });

    // Render files
    files.forEach(([name, data]) => {
        const isActive = currentFile === data._fullPath;
        html += `
            <div class="file-item ${isActive ? 'active' : ''}" onclick="loadFile('${data._fullPath}')">
                <svg class="file-icon file-icon-default" viewBox="0 0 16 16">
                    <path d="M3.5 1.75v11.5c0 .09.048.173.126.217a.25.25 0 0 0 .262-.012l5.75-3.5a.25.25 0 0 0 0-.426l-5.75-3.5a.25.25 0 0 0-.262-.012.249.249 0 0 0-.126.217V1.75Z M2 1.75C2 .784 2.784 0 3.75 0h8.5C13.216 0 14 .784 14 1.75v12.5A1.75 1.75 0 0 1 12.25 16h-8.5A1.75 1.75 0 0 1 2 14.25V1.75Z"></path>
                </svg>
                <span class="file-name">${name}</span>
            </div>
        `;
    });

    fileList.innerHTML = html;
}

// Open folder
function openFolder(folderName) {
    currentPath.push(folderName);
    renderFileList();
    updateBreadcrumb();
}

// Load files from API
async function loadFiles(selectedFile = null) {
    clearError();
    try {
        const res = await fetch(`${API}/api/list?user=${user}`);
        const data = await res.json();

        if (data.error) return showError("Failed to load files: " + data.error);

        allFiles = data.files || [];
        renderFileList();
        updateBreadcrumb();

        if (selectedFile && allFiles.includes(selectedFile)) loadFile(selectedFile);

    } catch (err) {
        showError("Failed to load files: " + err.message);
    }
}

// Load single file
async function loadFile(filepath) {
    currentFile = filepath;
    try {
        const res = await fetch(`${API}/api/load?user=${user}&filename=${filepath}`);
        document.getElementById("editor").value = await res.text();
        renderFileList(); // Re-render to show active state
    } catch (err) {
        showError("Failed to load file: " + err.message);
    }
}

// Create folder
function createFolder() {
    if (currentPath.length >= MAX_FOLDER_DEPTH) {
        showError(`Maximum folder depth of ${MAX_FOLDER_DEPTH} reached!`);
        return;
    }
    openModal('folderModal');
}

async function confirmCreateFolder() {
    const folderName = document.getElementById('folderName').value.trim();
    closeModal('folderModal');
    
    if (!folderName) return showError("Folder name cannot be empty");
    if (folderName.includes('/')) return showError("Folder name cannot contain '/'");
    
    // Create a placeholder file in the folder
    const folderPath = [...currentPath, folderName].join('/');
    const placeholderFile = `${folderPath}/.gitkeep`;
    
    try {
        const res = await fetch(`${API}/api/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user, pass, filename: placeholderFile, content: "" })
        });

        const data = await res.json();
        if (data.error) return showError("Failed to create folder: " + data.error);

        showSuccess("Folder created!");
        document.getElementById('folderName').value = '';
        loadFiles();

    } catch (err) {
        showError("Failed to create folder: " + err.message);
    }
}

// Create file
function createFile() {
    document.getElementById('createTitle').textContent = currentPath.length > 0 
        ? `Create File in ${currentPath.join('/')}`
        : 'Create New File';
    openModal('createModal');
}

async function confirmCreate() {
    let filename = document.getElementById('createFilename').value.trim();
    closeModal('createModal');

    if (!filename) return showError("Filename cannot be empty");

    // If we're in a subfolder and filename doesn't include path, prepend current path
    if (currentPath.length > 0 && !filename.includes('/')) {
        filename = [...currentPath, filename].join('/');
    }

    try {
        const res = await fetch(`${API}/api/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user, pass, filename, content: "" })
        });

        const data = await res.json();
        if (data.error) return showError("Failed to create file: " + data.error);

        showSuccess("File created!");
        document.getElementById('createFilename').value = '';
        loadFiles(filename);

    } catch (err) {
        showError("Failed to create file: " + err.message);
    }
}

// Save file
async function saveFile() {
    if (!currentFile) return showError("Select a file first");

    try {
        const res = await fetch(`${API}/api/save`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                user,
                pass,
                filename: currentFile,
                content: document.getElementById("editor").value
            })
        });

        const data = await res.json();
        if (!data.success) return showError("Failed to save file: " + (data.error || "Unknown error"));

        showSuccess("File saved!");
        loadFiles(currentFile);

    } catch (err) {
        showError("Failed to save file: " + err.message);
    }
}

// Upload image
function openUpload() {
    document.getElementById('uploadFilename').value = currentPath.length > 0 
        ? currentPath.join('/') + '/'
        : '';
    openModal('uploadModal');
}

document.getElementById("uploadDrop").onclick = () => {
    document.getElementById("uploadInput").click();
};

document.getElementById("uploadInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    uploadFileData = await file.arrayBuffer();

    const reader = new FileReader();
    reader.onload = () => {
        document.getElementById("uploadPreview").src = reader.result;
        document.getElementById("uploadPreview").style.display = "block";
    };
    reader.readAsDataURL(file);
});

async function uploadAndDeployImageBinary() {
    let filename = document.getElementById("uploadFilename").value.trim();
    
    if (!filename) return showError("Filename required!");
    if (!uploadFileData) return showError("Select an image first!");

    try {
        // Upload binary to KV
        const saveRes = await fetch(`${API}/api/img-save`, {
            method: "POST",
            headers: {
                "Content-Type": "application/octet-stream",
                "x-user": user,
                "x-pass": pass,
                "x-filename": filename
            },
            body: uploadFileData
        });

        const saveJson = await saveRes.json();
        if (!saveJson.success) return showError("KV Binary Save Failed: " + (saveJson.error || "Unknown"));

        // Deploy to GitHub
        const deployRes = await fetch(`${API}/api/img-deploy`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user, filename })
        });

        const deployJson = await deployRes.json();
        if (!deployJson.success) return showError("GitHub Upload Failed: " + JSON.stringify(deployJson));

        showSuccess("Image uploaded and deployed!");
        closeModal('uploadModal');
        document.getElementById('uploadFilename').value = '';
        document.getElementById('uploadPreview').style.display = 'none';
        uploadFileData = null;
        loadFiles(filename);

    } catch (err) {
        showError("Upload failed: " + err.message);
    }
}

// Delete folder
async function deleteFolder(folderName) {
    if (!confirm(`Delete folder "${folderName}" and all its contents? This cannot be undone!`)) return;
    
    const folderPrefix = [...currentPath, folderName].join('/') + '/';
    const filesToDelete = allFiles.filter(f => f.startsWith(folderPrefix));
    
    if (filesToDelete.length === 0) {
        showError("Folder is empty or doesn't exist");
        return;
    }
    
    try {
        for (const file of filesToDelete) {
            const res = await fetch(`${API}/api/delete-file`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: user, pass, filename: file })
            });
            
            const data = await res.json();
            if (!data.success) {
                showError(`Failed to delete ${file}: ` + (data.error || "Unknown error"));
                return;
            }
        }
        
        showSuccess("Folder deleted!");
        if (currentFile && currentFile.startsWith(folderPrefix)) {
            currentFile = null;
            document.getElementById("editor").value = "";
        }
        loadFiles();
        
    } catch (err) {
        showError("Delete failed: " + err.message);
    }
}

// Delete current file
async function deleteCurrentFile() {
    if (!currentFile) return showError("Select a file first");
    if (!confirm(`Delete ${currentFile}? This cannot be undone!`)) return;

    try {
        const res = await fetch(`${API}/api/delete-file`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: user, pass, filename: currentFile })
        });

        const data = await res.json();
        if (!data.success) return showError(data.error || "Delete failed");

        showSuccess("File deleted!");
        currentFile = null;
        document.getElementById("editor").value = "";
        loadFiles();

    } catch (err) {
        showError("Delete failed: " + err.message);
    }
}

// Download file
function downloadCurrentFile() {
    if (!currentFile) return showError("Select a file first");

    let content = document.getElementById("editor").value;
    const blob = new Blob([content], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = currentFile.split('/').pop();
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showSuccess("File downloaded!");
}

// Deploy
async function deploy() {
    if (!currentFile) return showError("Select a file first");
    showSuccess(`Deployed! https://code-mon-space.pages.dev/@me/user=${user}&filename=${currentFile}`);
}

// Album
function album() {
    window.location.href = `https://code-mon-space.pages.dev/album?user=${user}`;
}

// Toggle options
function toggleOptions() {
    const menu = document.getElementById("optionsMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

// Close modals on outside click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});
</script>

</body>
</html>
