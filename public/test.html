<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PWA</title>
  <link id="manifestLink" rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #app { padding: 20px; }
    button#installBtn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      font-size: 16px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="app">Loading app...</div>
  <button id="installBtn">Install App</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const appName = urlParams.get('name');

    const appContainer = document.getElementById('app');

    if (!appName) {
      appContainer.innerHTML = "<h2>No app name provided!</h2>";
    } else {
      const manifestUrl = `https://code-mon-space.codemon.workers.dev/api/engine?name=${encodeURIComponent(appName)}`;
      
      // Set manifest for PWA install
      const manifestLink = document.getElementById("manifestLink");
      manifestLink.href = manifestUrl;

      // Fetch manifest JSON
      fetch(manifestUrl)
        .then(res => res.json())
        .then(manifest => {
          // Fetch and load user HTML from start_url
          fetch(manifest.start_url)
            .then(res => res.text())
            .then(html => {
              appContainer.innerHTML = html;

              // Optionally load CSS/JS if specified in manifest.start_url
              // (e.g., for dynamically generated URLs)
              // You can extend here if needed
            })
            .catch(() => {
              appContainer.innerHTML = "<h2>Failed to load app content.</h2>";
            });
        })
        .catch(() => {
          appContainer.innerHTML = "<h2>Failed to load app manifest.</h2>";
        });
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // Handle PWA install button
    let deferredPrompt;
    const installBtn = document.getElementById("installBtn");
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });
    installBtn.addEventListener('click', async () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    });
  </script>
</body>
</html>
